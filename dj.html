<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DJ • Personal Command Center</title>

  <!-- Fonts & AOS to match site style -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #000;
      --text: #f5f5f5;
      --muted: #bbb;
      --panel: #181818;
      --panel-2: #222;
      --gold: gold;
      --accent: #ffb84d;
      --shadow: rgba(255, 215, 0, 0.12);
    }

    /* Base */
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.6;
      overflow-x: hidden;
      position: relative;
      z-index: 0;
    }
    a { color: var(--gold); text-decoration: none; }

    /* Hero / header */
    header {
      text-align: center;
      padding: 3rem 1rem 1.25rem;
      position: relative;
    }
    .hero-title {
      font-family: 'DM Serif Display', serif;
      font-size: clamp(2rem, 5vw, 3.25rem);
      margin: 0 0 .25rem 0;
      background: linear-gradient(90deg, gold, orange);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: .5px;
    }
    .hero-subtitle { color: #ddd; font-size: 1.05rem; margin: 0; }

    /* Blobby vibes to match main site */
    body::before, body::after, .blob { position: absolute; border-radius: 50%; z-index: -1; pointer-events: none; }
    body::before {
      content: '';
      width: 600px; height: 600px; top: -100px; left: -100px;
      background: radial-gradient(circle, rgba(255, 215, 0, 0.35), transparent 70%);
      filter: blur(100px);
      animation: driftGold 20s ease-in-out infinite;
    }
    body::after {
      content: '';
      width: 500px; height: 500px; right: -150px; bottom: -100px;
      background: radial-gradient(circle, rgba(0, 100, 255, 0.34), transparent 70%);
      filter: blur(80px);
      animation: driftBlue 30s ease-in-out infinite;
    }
    .blob.white {
      width: 480px; height: 480px; left: 60%; top: 22%;
      background: radial-gradient(circle, rgba(255,255,255,.3), transparent 70%);
      filter: blur(80px);
      animation: driftWhite 25s ease-in-out infinite;
    }
    @keyframes driftGold { 0%{transform:translate(0,0)} 50%{transform:translate(100px,150px)} 100%{transform:translate(0,0)} }
    @keyframes driftBlue { 0%{transform:translate(0,0)} 50%{transform:translate(-120px,-80px)} 100%{transform:translate(0,0)} }
    @keyframes driftWhite { 0%{transform:translate(0,0)} 50%{transform:translate(-50px,-30px)} 100%{transform:translate(0,0)} }

    /* Shell */
    .container { max-width: 1100px; margin: 0 auto; padding: 1rem; }

    .nav {
      display: flex; gap: .6rem; justify-content: center; flex-wrap: wrap;
      padding: 1rem; position: sticky; top: 0; background: rgba(0,0,0,.5);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,.06);
      z-index: 5;
    }
    .tab-btn {
      font-weight: 700; letter-spacing: .3px;
      padding: .55rem 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,.08);
      background: #111; color: var(--text);
      box-shadow: 0 0 8px var(--shadow);
      transition: transform .15s ease, box-shadow .15s ease, background .2s;
      cursor: pointer;
    }
    .tab-btn.active { background: linear-gradient(90deg, rgba(255,215,0,.15), rgba(255,165,0,.08)); border-color: rgba(255,215,0,.35); }
    .tab-btn:hover { transform: translateY(-1px); box-shadow: 0 0 16px var(--shadow); }

    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; }
    .card {
      background: var(--panel-2);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      box-shadow: 0 0 18px var(--shadow);
      padding: 1rem;
    }
    h2.section-title {
      font-family: 'DM Serif Display', serif;
      color: var(--gold);
      font-size: 1.8rem; letter-spacing: .4px; margin: .25rem 0 1rem;
      text-shadow: 0 0 12px rgba(255, 215, 0, 0.35);
    }

    .muted { color: var(--muted); font-size: .95rem; }
    .row { display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
    .input, select, textarea {
      background: #121212; color: var(--text);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 10px; padding: .6rem .75rem; font: inherit;
    }
    .btn {
      display: inline-flex; align-items: center; gap: .4rem; cursor: pointer;
      background: var(--gold); color: #111; font-weight: 800; border: 0;
      border-radius: 10px; padding: .6rem .95rem; transition: transform .12s ease, box-shadow .2s ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 0 18px rgba(255,215,0,.4); }
    .btn.secondary { background: #2a2a2a; color: var(--text); border: 1px solid rgba(255,255,255,.08); }

    .kpi { display: grid; grid-template-columns: repeat(4, 1fr); gap: .8rem; }
    .kpi > div { background: #151515; border: 1px solid rgba(255,255,255,.06); border-radius: 12px; padding: .8rem; }
    .kpi .label { color: var(--muted); font-size: .8rem; }
    .kpi .value { font-weight: 800; font-size: 1.35rem; }

    /* Habit Tracker */
    #habits .habit-list { display: grid; grid-template-columns: 1fr auto auto; gap: .6rem; align-items: center; }
    .habit-list .habit { background:#141414; padding:.7rem .8rem; border-radius:10px; border:1px solid rgba(255,255,255,.07); }
    .progress-wrap { display:flex; align-items:center; gap:.6rem; }
    .progress {
      height: 10px; width: 100%; background: #0e0e0e; border-radius: 999px; overflow: hidden; border:1px solid rgba(255,255,255,.06);
    }
    .progress > span { display:block; height:100%; width:0; background: linear-gradient(90deg, gold, orange); transition: width .3s ease; }

    /* Notes */
    .notes { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: .9rem; }
    .note { background:#141414; border:1px solid rgba(255,255,255,.07); border-radius: 12px; padding:.8rem; display:flex; flex-direction:column; gap:.5rem; }
    .note small { color: var(--muted); }
    .note .actions { display:flex; gap:.4rem; justify-content:flex-end; }

    /* Finance */
    .dropzone { border: 1px dashed rgba(255,215,0,.35); border-radius: 12px; background:#121212; padding: 1rem; text-align: center; }
    table { width:100%; border-collapse: collapse; font-size:.95rem; }
    th, td { text-align:left; padding:.55rem .6rem; border-bottom: 1px solid rgba(255,255,255,.06); }
    th { color: var(--gold); font-weight:800; }

    /* Password gate */
    .gate {
      position: fixed; inset: 0; display: grid; place-items: center; background: radial-gradient(ellipse at 10% -20%, rgba(255,215,0,.15), transparent 60%), rgba(0,0,0,.85);
      backdrop-filter: blur(6px);
      z-index: 9999;
    }
    .gate .panel { background: var(--panel); border:1px solid rgba(255,255,255,.1); border-radius: 16px; padding: 1.25rem; width:min(92vw, 420px); box-shadow: 0 0 24px var(--shadow); }
    .gate h1 { font-family:'DM Serif Display', serif; font-size: 1.8rem; margin:.2rem 0 .6rem; background: linear-gradient(90deg, gold, orange); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    /* Utility */
    .hidden { display: none !important; }

    @media (max-width: 768px) {
      .kpi { grid-template-columns: repeat(2, 1fr); }
      .blob.white { width: 360px; height: 360px; filter: blur(60px); opacity: .8; }
    }
  </style>
</head>
<body>
  <!-- decorative blobs -->
  <div class="blob white" aria-hidden="true"></div>

  <!-- Password Gate (client-side only; obfuscation, not security) -->
  <div id="gate" class="gate">
    <div class="panel" data-aos="zoom-in">
      <h1>Enter Access Code</h1>
      <p class="muted" style="margin-top:-.25rem">Private utilities for Dustin • Keep this between us ✨</p>
      <form id="gateForm" class="row" style="margin-top:.8rem" autocomplete="off">
        <input id="pw" class="input" type="password" placeholder="Code" autofocus />
        <button class="btn" type="submit">Unlock</button>
        <button class="btn secondary" id="cancelGate" type="button">Cancel</button>
      </form>
      <p class="muted" style="margin:.6rem 0 0">Heads up: This is client‑side and not truly secure.</p>
    </div>
  </div>

  <header>
    <h1 class="hero-title">DJ • Personal Command Center</h1>
    <p class="hero-subtitle">second brain • habit tracker • finance glance</p>
  </header>

  <nav class="nav" role="tablist">
    <button class="tab-btn active" data-tab="habits">Habits</button>
    <button class="tab-btn" data-tab="brain">Second Brain</button>
    <button class="tab-btn" data-tab="finance">Finance</button>
    <span style="margin-left:auto"></span>
    <a class="tab-btn" href="/" style="text-decoration:none">← Back to Site</a>
    <button class="tab-btn" id="relock">Lock</button>
  </nav>

  <main class="container">
    <!-- HABITS -->
    <section id="habits" class="tab" data-aos="fade-up">
      <h2 class="section-title">Daily Habits</h2>
      <div class="kpi" style="margin-bottom: .8rem">
        <div><div class="label">Today</div><div id="todayLabel" class="value">—</div></div>
        <div><div class="label">Completed</div><div id="habitsDone" class="value">0</div></div>
        <div><div class="label">Total Habits</div><div id="habitsTotal" class="value">0</div></div>
        <div><div class="label">Progress</div><div class="value"><span id="progressPct">0%</span></div></div>
      </div>
      <div class="card">
        <div class="progress-wrap" style="margin-bottom: .8rem">
          <div class="progress"><span id="progressBar"></span></div>
          <button class="btn secondary" id="prevDay">←</button>
          <button class="btn secondary" id="nextDay">→</button>
        </div>
        <div class="row" style="margin:.4rem 0 .8rem">
          <input id="newHabitInput" class="input" placeholder="Add a new habit (e.g., Workout)" />
          <button id="addHabitBtn" class="btn">Add</button>
          <button id="clearTodayBtn" class="btn secondary">Clear today</button>
        </div>
        <div id="habitList" class="habit-list"></div>
      </div>
    </section>

    <!-- BRAIN -->
    <section id="brain" class="tab hidden" data-aos="fade-up">
      <h2 class="section-title">Second Brain</h2>
      <div class="grid">
        <div class="card" style="grid-column: span 6">
          <h3 style="margin-top:0">Quick Capture</h3>
          <div class="row">
            <input id="noteTitle" class="input" style="flex:1" placeholder="Title" />
          </div>
          <textarea id="noteBody" class="input" rows="6" placeholder="Write anything… (markdown-friendly; stored locally)"></textarea>
          <div class="row">
            <input id="noteTags" class="input" style="flex:1" placeholder="#tags (comma or space)" />
            <button id="addNote" class="btn">Save Note</button>
          </div>
        </div>
        <div class="card" style="grid-column: span 6">
          <h3 style="margin-top:0">Search & Filter</h3>
          <div class="row">
            <input id="search" class="input" style="flex:1" placeholder="Search title/body/tags" />
            <button id="exportNotes" class="btn secondary">Export JSON</button>
            <label class="btn secondary" for="importNotesInput">Import JSON</label>
            <input id="importNotesInput" type="file" accept="application/json" style="display:none" />
          </div>
          <p class="muted">Notes are stored in your browser (localStorage). Export occasionally.</p>
        </div>
      </div>
      <div class="notes" id="notes"></div>
    </section>

    <!-- FINANCE -->
    <section id="finance" class="tab hidden" data-aos="fade-up">
      <h2 class="section-title">Finance Glance</h2>
      <div class="grid">
        <div class="card" style="grid-column: span 7">
          <div class="dropzone" id="dropzone">
            <p><strong>Drop a CSV</strong> or <label for="fileInput" style="cursor:pointer; text-decoration:underline">choose a file</label> to analyze.</p>
            <input id="fileInput" type="file" accept=".csv" style="display:none" />
            <p class="muted">Expected columns: <em>Date</em>, <em>Description</em>, <em>Amount</em>. Amount negative for expenses.</p>
          </div>
          <div style="margin-top:1rem" class="kpi">
            <div><div class="label">Inflow</div><div id="inflow" class="value">$0</div></div>
            <div><div class="label">Outflow</div><div id="outflow" class="value">$0</div></div>
            <div><div class="label">Net</div><div id="net" class="value">$0</div></div>
            <div><div class="label">Transactions</div><div id="txCount" class="value">0</div></div>
          </div>
          <div class="card" style="margin-top:1rem; background:#141414">
            <canvas id="monthlyChart" height="140"></canvas>
          </div>
        </div>
        <div class="card" style="grid-column: span 5">
          <h3 style="margin-top:0">Category Rules</h3>
          <p class="muted">Simple keyword → category mapping. Example: <code>TRADER JOE</code> → <code>Groceries</code></p>
          <div class="row">
            <input id="ruleKeyword" class="input" placeholder="Keyword contains…" />
            <input id="ruleCategory" class="input" placeholder="Category" />
            <button id="addRule" class="btn">Add</button>
            <button id="clearRules" class="btn secondary">Clear</button>
          </div>
          <div id="rulesList" style="margin-top:.6rem" class="muted"></div>
        </div>
      </div>
      <div class="card" style="margin-top:1rem; overflow:auto">
        <table id="txTable" class="hidden">
          <thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Category</th></tr></thead>
          <tbody></tbody>
        </table>
        <p id="noData" class="muted" style="margin: .4rem 0 0">No data yet.</p>
      </div>
    </section>
  </main>

  <!-- AOS & Chart.js -->
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
  // ===== Utilities
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const todayISO = (d=new Date()) => d.toISOString().slice(0,10);
  const fmtUSD = n => (n<0?'-':'') + '$' + Math.abs(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});

  // ===== Password Gate (client-side only)
  const PASSWORD = 'dj';
  const GATE_KEY = 'dj_authed';
  const gateEl = $('#gate');
  const pwEl = $('#pw');
  const cancelGate = $('#cancelGate');
  const reLockBtn = $('#relock');

  function openGateIfAuthed(){
    if(sessionStorage.getItem(GATE_KEY)==='1'){ gateEl.classList.add('hidden'); }
  }
  function lock(){ sessionStorage.removeItem(GATE_KEY); gateEl.classList.remove('hidden'); pwEl.value=''; pwEl.focus(); }

  $('#gateForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    if(pwEl.value === PASSWORD){ sessionStorage.setItem(GATE_KEY,'1'); gateEl.classList.add('hidden'); } else { pwEl.value=''; pwEl.placeholder='Nope'; pwEl.focus(); }
  });
  cancelGate.addEventListener('click', ()=>{ window.location.href = '/'; });
  reLockBtn.addEventListener('click', lock);

  // Quick stealth hide on Escape
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ lock(); } });

  // ===== Tabs
  const tabs = $$('.tab-btn');
  tabs.forEach(btn=>btn.addEventListener('click', ()=>{
    if(!btn.dataset.tab) return;
    $$('.tab-btn').forEach(b=>b.classList.toggle('active', b===btn));
    $$('.tab').forEach(s=>s.classList.toggle('hidden', s.id !== btn.dataset.tab));
  }));

  // ===== HABITS
  const HABITS_KEY = 'dj_habits_list'; // ["Workout", ...]
  const DAYS_KEY = 'dj_habits_days';   // { '2025-08-13': { Workout:true, Read:false } }
  const todayLabel = $('#todayLabel');
  const habitsDone = $('#habitsDone');
  const habitsTotal = $('#habitsTotal');
  const progressPct = $('#progressPct');
  const progressBar = $('#progressBar');
  const habitList = $('#habitList');
  const newHabitInput = $('#newHabitInput');
  let currentDay = todayISO();

  function getHabits(){ return JSON.parse(localStorage.getItem(HABITS_KEY) || '[]'); }
  function setHabits(arr){ localStorage.setItem(HABITS_KEY, JSON.stringify(arr)); }
  function getDays(){ return JSON.parse(localStorage.getItem(DAYS_KEY) || '{}'); }
  function setDays(obj){ localStorage.setItem(DAYS_KEY, JSON.stringify(obj)); }

  function renderHabits(){
    todayLabel.textContent = currentDay;
    const habits = getHabits();
    const days = getDays();
    const todayMap = days[currentDay] || {};
    habitList.innerHTML = '';

    habits.forEach(h=>{
      const row = document.createElement('div');
      row.className = 'row habit';
      row.innerHTML = `
        <div class="habit" style="flex:1">${h}</div>
        <label class="row" style="gap:.4rem"><input type="checkbox" ${todayMap[h]?'checked':''}/> Done</label>
        <button class="btn secondary">Delete</button>
      `;
      const cb = row.querySelector('input[type="checkbox"]');
      cb.addEventListener('change', ()=>{
        const d = getDays();
        d[currentDay] = d[currentDay] || {};
        d[currentDay][h] = cb.checked;
        setDays(d);
        updateProgress();
      });
      row.querySelector('button').addEventListener('click', ()=>{
        if(!confirm(`Delete habit "${h}"?`)) return;
        const newList = getHabits().filter(x=>x!==h);
        setHabits(newList);
        // also remove from all days
        const d = getDays();
        Object.keys(d).forEach(day=>{ if(d[day]) delete d[day][h]; });
        setDays(d);
        renderHabits();
      });
      habitList.appendChild(row);
    });
    updateProgress();
  }

  function updateProgress(){
    const habits = getHabits();
    const d = getDays()[currentDay] || {};
    const total = habits.length;
    const done = habits.filter(h=>d[h]).length;
    habitsTotal.textContent = total;
    habitsDone.textContent = done;
    const pct = total ? Math.round(100*done/total) : 0;
    progressPct.textContent = pct + '%';
    progressBar.style.width = pct + '%';
  }

  $('#addHabitBtn').addEventListener('click', ()=>{
    const name = newHabitInput.value.trim();
    if(!name) return;
    const list = getHabits();
    if(!list.includes(name)) list.push(name);
    setHabits(list);
    newHabitInput.value='';
    renderHabits();
  });

  $('#clearTodayBtn').addEventListener('click', ()=>{
    const days = getDays();
    if(days[currentDay]){ Object.keys(days[currentDay]).forEach(k=>days[currentDay][k]=false); setDays(days); renderHabits(); }
  });
  $('#prevDay').addEventListener('click', ()=>{ const d = new Date(currentDay); d.setDate(d.getDate()-1); currentDay = todayISO(d); renderHabits(); });
  $('#nextDay').addEventListener('click', ()=>{ const d = new Date(currentDay); d.setDate(d.getDate()+1); currentDay = todayISO(d); renderHabits(); });

  // Seed default habits once
  if(!localStorage.getItem(HABITS_KEY)) setHabits(['Workout','Read','Code','Meditate','Hydrate']);

  // ===== SECOND BRAIN (notes)
  const NOTES_KEY = 'dj_notes_v1'; // array of {id, title, body, tags:[...], ts}
  function loadNotes(){ return JSON.parse(localStorage.getItem(NOTES_KEY)||'[]'); }
  function saveNotes(arr){ localStorage.setItem(NOTES_KEY, JSON.stringify(arr)); }
  function renderNotes(){
    const q = $('#search').value.trim().toLowerCase();
    const list = loadNotes().filter(n=>{
      if(!q) return true;
      return (n.title+n.body+n.tags.join(',')).toLowerCase().includes(q);
    }).sort((a,b)=>b.ts-a.ts);
    const wrap = $('#notes');
    wrap.innerHTML = '';
    list.forEach(n=>{
      const el = document.createElement('div');
      el.className = 'note';
      el.innerHTML = `
        <strong>${escapeHTML(n.title||'Untitled')}</strong>
        <small>${new Date(n.ts).toLocaleString()} • ${n.tags.map(t=>'#'+t).join(' ')}</small>
        <div style="white-space: pre-wrap">${escapeHTML(n.body)}</div>
        <div class="actions">
          <button class="btn secondary" data-act="edit">Edit</button>
          <button class="btn secondary" data-act="del">Delete</button>
        </div>
      `;
      el.querySelector('[data-act="del"]').addEventListener('click', ()=>{
        if(!confirm('Delete note?')) return;
        const arr = loadNotes().filter(x=>x.id!==n.id); saveNotes(arr); renderNotes();
      });
      el.querySelector('[data-act="edit"]').addEventListener('click', ()=>{
        const title = prompt('Title', n.title) ?? n.title;
        const body = prompt('Body', n.body) ?? n.body;
        const tags = prompt('Tags (comma/space)', n.tags.join(' ')) ?? n.tags.join(' ');
        const arr = loadNotes();
        const idx = arr.findIndex(x=>x.id===n.id);
        if(idx>-1){ arr[idx] = { ...n, title, body, tags: splitTags(tags), ts: Date.now() }; saveNotes(arr); renderNotes(); }
      });
      wrap.appendChild(el);
    });
  }

  function splitTags(str){
    return (str||'').split(/[#,\s]+/).map(s=>s.trim()).filter(Boolean);
  }
  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  $('#addNote').addEventListener('click', ()=>{
    const title = $('#noteTitle').value.trim();
    const body = $('#noteBody').value.trim();
    const tags = splitTags($('#noteTags').value);
    if(!title && !body) return;
    const arr = loadNotes();
    arr.push({ id: crypto.randomUUID(), title, body, tags, ts: Date.now() });
    saveNotes(arr);
    $('#noteTitle').value=''; $('#noteBody').value=''; $('#noteTags').value='';
    renderNotes();
  });
  $('#search').addEventListener('input', renderNotes);
  $('#exportNotes').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(loadNotes(), null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = 'dj-notes.json'; a.click();
  });
  $('#importNotesInput').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return; const r = new FileReader();
    r.onload = ()=>{ try { const arr = JSON.parse(r.result); if(Array.isArray(arr)) { saveNotes(arr); renderNotes(); } } catch(err){ alert('Invalid JSON'); } };
    r.readAsText(f);
  });

  // ===== FINANCE
  const RULES_KEY = 'dj_rules_v1';
  function loadRules(){ return JSON.parse(localStorage.getItem(RULES_KEY)||'[]'); }
  function saveRules(arr){ localStorage.setItem(RULES_KEY, JSON.stringify(arr)); renderRules(); }
  function renderRules(){
    const rules = loadRules();
    const list = rules.map((r,i)=>`<div class="row" style="justify-content:space-between"><span>${escapeHTML(r.keyword)} → <strong>${escapeHTML(r.category)}</strong></span><button class="btn secondary" data-i="${i}">Remove</button></div>`).join('');
    $('#rulesList').innerHTML = list || '<span class="muted">No rules yet.</span>';
    $$('#rulesList button').forEach(b=>b.addEventListener('click', ()=>{ const i = +b.dataset.i; const arr = loadRules(); arr.splice(i,1); saveRules(arr); }));
  }
  $('#addRule').addEventListener('click', ()=>{
    const kw = $('#ruleKeyword').value.trim(); const cat = $('#ruleCategory').value.trim();
    if(!kw || !cat) return;
    saveRules([...loadRules(), { keyword: kw.toLowerCase(), category: cat }]);
    $('#ruleKeyword').value=''; $('#ruleCategory').value='';
  });
  $('#clearRules').addEventListener('click', ()=>{ if(confirm('Clear all rules?')) saveRules([]); });

  const txTable = $('#txTable');
  const txBody = txTable.querySelector('tbody');
  let chart;

  function parseCSV(text){
    // basic CSV split; handles commas inside quotes
    const rows = [];
    let i = 0, field = '', inQ = false, row = [];
    for(const ch of text){
      if(ch === '"'){ inQ = !inQ; continue; }
      if(ch === ',' && !inQ){ row.push(field); field=''; continue; }
      if((ch === '\n' || ch === '\r') && !inQ){ if(field!=='' || row.length){ row.push(field); rows.push(row); row=[]; field=''; } continue; }
      field += ch;
    }
    if(field!=='' || row.length) { row.push(field); rows.push(row); }
    return rows.filter(r=>r.length>1);
  }

  function categorize(desc){
    const d = (desc||'').toLowerCase();
    for(const r of loadRules()) if(d.includes(r.keyword)) return r.category;
    return 'Uncategorized';
  }

  function analyze(records){
    // records: [{date, desc, amount}]
    let inflow=0, outflow=0;
    const monthly = {}; // {YYYY-MM: sum}
    txBody.innerHTML='';
    for(const r of records){
      const amt = +r.amount;
      inflow += Math.max(0, amt);
      outflow += Math.min(0, amt);
      const ym = (r.date||'').slice(0,7) || 'Unknown';
      monthly[ym] = (monthly[ym]||0) + amt;
      const cat = categorize(r.desc);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHTML(r.date)}</td><td>${escapeHTML(r.desc)}</td><td>${fmtUSD(amt)}</td><td>${escapeHTML(cat)}</td>`;
      txBody.appendChild(tr);
    }
    $('#inflow').textContent = fmtUSD(inflow);
    $('#outflow').textContent = fmtUSD(outflow);
    $('#net').textContent = fmtUSD(inflow+outflow);
    $('#txCount').textContent = records.length;
    $('#noData').classList.add('hidden');
    txTable.classList.remove('hidden');

    // chart
    const labels = Object.keys(monthly).sort();
    const data = labels.map(k=> +monthly[k].toFixed(2));
    const ctx = document.getElementById('monthlyChart');
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Net by Month', data }] },
      options: { responsive: true, plugins: { legend: { display: true } }, scales: { x: { grid:{ display:false } }, y: { grid: { color: 'rgba(255,255,255,.06)' } } } }
    });
  }

  function handleCSV(text){
    const rows = parseCSV(text);
    if(!rows.length) return alert('No rows parsed.');
    // Attempt to detect header
    const headers = rows[0].map(h=>h.trim().toLowerCase());
    const looksHeader = headers.some(h => ['date','description','amount'].includes(h));
    const dataRows = looksHeader ? rows.slice(1) : rows;
    const idxDate = headers.indexOf('date');
    const idxDesc = headers.indexOf('description');
    const idxAmt  = headers.indexOf('amount');

    const recs = dataRows.map(r=>({
      date: (idxDate>-1 ? r[idxDate] : r[0]||'').trim(),
      desc: (idxDesc>-1 ? r[idxDesc] : r[1]||'').trim(),
      amount: (idxAmt>-1 ? r[idxAmt] : r[2]||'0').replace(/[$,]/g,'')
    })).filter(r=>r.amount && !isNaN(+r.amount));

    analyze(recs);
  }

  $('#fileInput').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return; const r = new FileReader();
    r.onload = ()=>handleCSV(r.result); r.readAsText(f);
  });
  const dz = $('#dropzone');
  dz.addEventListener('dragover', (e)=>{ e.preventDefault(); dz.style.borderColor = 'gold'; });
  dz.addEventListener('dragleave', ()=>{ dz.style.borderColor = 'rgba(255,215,0,.35)'; });
  dz.addEventListener('drop', (e)=>{ e.preventDefault(); dz.style.borderColor = 'rgba(255,215,0,.35)'; const f = e.dataTransfer.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>handleCSV(r.result); r.readAsText(f); });

  // ===== Init
  AOS.init({ duration: 1000, once: true, easing: 'ease-out-back' });
  openGateIfAuthed();
  renderHabits();
  renderNotes();
  renderRules();
  </script>
</body>
</html>
